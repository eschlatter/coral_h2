---
title: "A. millepora larval trait heritability"
author: "E Schlatter"
date: "8/21/2023"
output:
  pdf_document:
    toc: true
    toc_depth: 4

---
## Intro
```{r message=FALSE, warning=FALSE, echo=FALSE}
#setwd("C:/Users/eschlatter/Dropbox/coral_h2")
library(tidyverse)
library(MasterBayes) #for pedigree functions
library(MCMCglmm) #for running the model
library(MCMCpack) #for inverse wishart distributions
library(bayesplot) #mcmc_areas plot function
library(gridExtra) #multiple plots per figure
library(knitr)
source('functions.R')
```


## Fluorescence
```{r, echo=FALSE}
load('data/fluor.RData')
```
The model I've used is **color ~ dam + rep + breeding value + residual.**

Each color is treated separately, for now.

I'm using the relative fluorescence of each color -- e.g., red / (red+blue+green).

I haven't transformed the data in any way. In Sarah's dissertation, she used arcsin(square root(relative fluorescence)).

**Animal Model**

This is an animal model: the "breeding value" term is essentially the contribution of additive genetic effect. (Breeding value is modeled as a normally-distributed random variable, with covariances among individuals according to their relatedness. The coefficient of this random variable is VA.) I've stuck to the animal model for now, since it sounds like that's what we'll use for gene expression.

**Sire effect not estimated separately from VA**

Sire isn't included as a predictor variable here. I think it makes sense not to try to estimate a sire effect separately from breeding value, since there's not much replication within sires. (That is: for each larva, we're already getting an estimate of the contribution of additive genetic effect to their phenotype. Trying to estimate the contribution of paternal ID on top of that -- i.e., how much sharing a father contributes to the similarity between two larvae, over and above the effect from the 1/4 additional relatedness -- is a lot to ask, given the number of offspring per sire.)

**Dam as a fixed effect**

I've modeled dam as a fixed effect. The only difference between a fixed and a random effect in a Bayesian model is that, for a random effect, you estimate the variance (among levels). For a fixed effect, the variance is set (usually to something large). With only two levels for dam, we don't have enough data to estimate the variance among dams in a meaningful way. So we should treat it as a fixed effect.

This introduces a problem when estimating heritability. By including dam as a fixed effect, we artificially inflate the estimate of heritability as it's usually calculated (VA divided by the sum of estimates of all variance components). Since there's no variance component representing the -- substantial! -- variation due to dam, the denominator is artificially small, and h2 is artificially large. [see: Wilson 2008, Journal of Evolutionary Biology: Why h^2 does not always equal VA/VP]

We can address this by estimating the variance due to the fixed effect, and including that in the denominator. I've followed de Villemereuil et al 2018 (eqn 7), and used some code from de Villemereuil's MCMCglmm animal model tutorial (Version 2, 2023, p.26). [Note: this is an improvement over my first try, just using the phenotypic variance as the denominator of h2. It gives quantitatively different results -- h2 of red fluorescence, e.g., is about 0.15 instead of 0.42. But the credible intervals are tighter -- as expected, since, in any given run, if more of the variance is attributed to fixed effects, less is attributed to random effects.]

Alternatively, we could include dam as a random effect, so that its associated variance is included in the denominator when estimating heritability. But, although the model *will* give us an answer when we ask it to estimate the variance attributed to dam, it's 1) not well-behaved (some iterations of the MCMC algorithm give preposterously high values, like 1000), and 2) isn't really meaningful, because it's estimated from only two data points (dam A and dam C).

**Influence of priors**

The prior I'm using in the results shown here is parameter expanded for the non-residual components (rep and animal), and uses the default inverse Wishart for residual (MCMCglmm can't do parameter expansion for the residual).

It's not shown here, but I've run these models with several different priors. They all have good mixing properties, and the estimates are essentially the same. I take that to mean there's enough signal in the data to overcome the influence of the prior we give it -- a good sign!

### Results

**Red fluorescence**

```{r echo=FALSE, message=FALSE}
load('models/red_fluor.RData')
red_est <- fn_get_estimates(red_fluor,herit_red_fluor)
kable(red_est)
```

**Blue fluorescence**

```{r echo=FALSE, message=FALSE}
load('models/blue_fluor.RData')
# vp_blue <- var(fluor$blue_rel,na.rm=TRUE)
# herit_blue <- blue_fluor$VCV[,1]/vp_blue
# blue_est_old <- fn_get_estimates(blue_fluor,herit_blue)
# kable(blue_est_old)
blue_est <- fn_get_estimates(blue_fluor,herit_blue_fluor)
kable(blue_est)
```

**Green fluorescence**

```{r echo=FALSE, message=FALSE}
load('models/green_fluor.RData')
# vp_green <- var(fluor$green_rel,na.rm=TRUE)
# herit_green <- green_fluor$VCV[,1]/vp_green
# green_est_old <- fn_get_estimates(green_fluor,herit_green)
# kable(green_est_old)
green_est <- fn_get_estimates(green_fluor,herit_green_fluor)
kable(green_est)
```

Detailed output of each of the three models below.

### Red
```{r,eval=FALSE, echo=FALSE}
#The default fixed effect prior has a zero mean vector and a diagonal variance matrix with large variances (1e+10). We'll leave that alone, and specify the random and residual effect priors as follows:
prior_red = list(R=list(V=1,nu=0.002),
                         G=list(G1=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1),
                                G2=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1)))

#If we treat dam as fixed, then MCMCglmm needs a dam assigned to each individual in the dataset, even the parents. We'll add dummy variables in for them. This is ok, since the parents' rows don't get used anyway (they don't have phenotype data).
fluor$dam <- as.character(fluor$dam)
fluor$dam[1:10] <- c('AA','BB','CC','DD','EE','FF','GG','HH','II','JJ')
fluor$dam <- as.factor(fluor$dam)

#fixed effects written as dam-1 means we don't specify a global intercept; each level of dam (A and C) has its own. 
red_fluor <- MCMCglmm(red_rel~dam-1,
                   random=~animal+rep,
                   prior=prior_red,
                   ginverse=list(animal=Ainv),
                   data=fluor,nitt=1000000,burnin=10000,thin=100,verbose=TRUE)

## this is the better way to calculate h2 with fixed effects.
# Rather than just dividing by the observed phenotypic variance, use the variance of the predicted values from the fixed effects as VF, and let VP = VF+VA+VE be the denominator.
# (See de Villemereuil 2023)
model <- red_fluor
X <- model[['X']] #design matrix relating observations (larvae) to fixed effects (dams)
VF <- apply(model[['Sol']],1,fn_compute_varpred,design_matrix=X) #multiply to get predicted phenotype, just based on dam, and take the variance of that over all larvae (once for each MCMC iteration)
herit_red_fluor <- model$VCV[,1]/(rowSums(model$VCV)+VF)

save(red_fluor,prior_red,herit_red_fluor,file='C:/Users/eschlatter/Dropbox/coral_h2/analysis/models/red_fluor.RData')
```

**MCMCglmm output:**

```{r echo=FALSE, message=FALSE, warning=FALSE}
load('models/red_fluor.RData')
model <- red_fluor

summary(model)
plot(model)
```

**Priors and posteriors:**

```{r echo=FALSE, message=FALSE, warning=FALSE}
fn_plot_all_priorandpost(model,prior_red,xlim=0.005)
```

**Heritability:**

```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(herit_red_fluor)
plot(herit_red_fluor)
```

### Blue

```{r,eval=FALSE, echo=FALSE}
#The default fixed effect prior has a zero mean vector and a diagonal variance matrix with large variances (1e+10). We'll leave that alone, and specify the random and residual effect priors as follows:
prior_blue = list(R=list(V=1,nu=0.002),
                         G=list(G1=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1),
                                G2=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1)))

#If we treat dam as fixed, then MCMCglmm needs a dam assigned to each individual in the dataset, even the parents. We'll add dummy variables in for them. This is ok, since the parents' rows don't get used anyway (they don't have phenotype data).
fluor$dam <- as.character(fluor$dam)
fluor$dam[1:10] <- c('AA','BB','CC','DD','EE','FF','GG','HH','II','JJ')
fluor$dam <- as.factor(fluor$dam)

#fixed effects written as dam-1 means we don't specify a global intercept; each level of dam (A and C) has its own. 
blue_fluor <- MCMCglmm(blue_rel~dam-1,
                   random=~animal+rep,
                   prior=prior_blue,
                   ginverse=list(animal=Ainv),
                   data=fluor,nitt=1000000,burnin=10000,thin=100,verbose=TRUE)

#calculate heritability
model <- blue_fluor
X <- model[['X']] #design matrix relating observations (larvae) to fixed effects (dams)
VF <- apply(model[['Sol']],1,fn_compute_varpred,design_matrix=X)
herit_blue_fluor <- model$VCV[,1]/(rowSums(model$VCV)+VF)

save(blue_fluor,prior_blue,herit_blue_fluor,file='C:/Users/eschlatter/Dropbox/coral_h2/analysis/models/blue_fluor.RData')
```

**MCMCglmm output:**

```{r, echo=FALSE, message=FALSE, warning=FALSE}
load('models/blue_fluor.RData')
model <- blue_fluor

summary(model)
plot(model)
```

**Priors and posteriors:**

```{r, echo=FALSE, message=FALSE, warning=FALSE}
fn_plot_all_priorandpost(model,prior_blue,xlim=0.005)
```

**Heritability:**

```{r, echo=FALSE, message=FALSE, warning=FALSE}
summary(herit_blue_fluor)
plot(herit_blue_fluor)
```

### Green

```{r,eval=FALSE, echo=FALSE}
#The default fixed effect prior has a zero mean vector and a diagonal variance matrix with large variances (1e+10). We'll leave that alone, and specify the random and residual effect priors as follows:
prior_green = list(R=list(V=1,nu=0.002),
                         G=list(G1=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1),
                                G2=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1)))

#If we treat dam as fixed, then MCMCglmm needs a dam assigned to each individual in the dataset, even the parents. We'll add dummy variables in for them. This is ok, since the parents' rows don't get used anyway (they don't have phenotype data).
fluor$dam <- as.character(fluor$dam)
fluor$dam[1:10] <- c('AA','BB','CC','DD','EE','FF','GG','HH','II','JJ')
fluor$dam <- as.factor(fluor$dam)

#fixed effects written as dam-1 means we don't specify a global intercept; each level of dam (A and C) has its own. 
green_fluor <- MCMCglmm(green_rel~dam-1,
                   random=~animal+rep,
                   prior=prior_green,
                   ginverse=list(animal=Ainv),
                   data=fluor,nitt=1000000,burnin=10000,thin=100,verbose=TRUE)

#calculate heritability
model <- green_fluor
X <- model[['X']] #design matrix relating observations (larvae) to fixed effects (dams)
VF <- apply(model[['Sol']],1,fn_compute_varpred,design_matrix=X)
herit_green_fluor <- model$VCV[,1]/(rowSums(model$VCV)+VF)

save(green_fluor,prior_green,herit_green_fluor,file='C:/Users/eschlatter/Dropbox/coral_h2/analysis/models/green_fluor.RData')
```

**MCMCglmm output:**

```{r, echo=FALSE, message=FALSE, warning=FALSE}
load('models/green_fluor.RData')
model <- green_fluor

summary(model)
plot(model)
```

**Priors and posteriors:**

```{r, echo=FALSE, message=FALSE, warning=FALSE}
fn_plot_all_priorandpost(model,prior_green,xlim=0.005)
```

**Heritability:**

```{r, echo=FALSE, message=FALSE, warning=FALSE}
summary(herit_green_fluor)
plot(herit_green_fluor)
```

## Settlement

```{r,echo=FALSE}
load('data/settlement.RData')
```

So far, I'm treating the 24-hour and 48-hour timepoints separately.

```{r, echo=FALSE, message=FALSE, fig.dim=c(3,3)}
hist(settlement_24$prop)
hist(settlement_48$prop)

hist(asin(sqrt(settlement_24$prop)))
hist(asin(sqrt(settlement_48$prop)))
```

These aren't normally-distributed data. They're proportions that vary between 0 and 1. The arcsin(sqrt) transformation makes them look a little more normal. But I'm pretty sure the estimation of variance components on the nonlinearly-transformed data doesn't translate in a straightforward way back to the original (what de Villemereuil et al 2018 calls the latent scale to the data scale).

I think the solution to this is a GLMM, where the response variable is modeled as a non-Gaussian distribution. I'm still working out how we implement this, with the fixed effect for dam, to get a heritability estimate on the scale of the original data.

- My first idea is to look at it as a binary response variable. Currently, each row of our data is one trial, with # larvae and # settlers (a total of n individuals). We could turn that into n rows of data, one for each individual, where the phenotype is 1=settled, 0=hasn't settled.

- As it's currently formatted, each data point comes from a binomial(n,p) distribution, but n varies among data points.


For now, let's try the untransformed and the transformed data, and see if there's any difference.

- **settlement proportion ~ dam + breeding value + residual**

- **??** Not including rep as a fixed effect. e.g., parents A and P have 6 datapoints at time 24: rep 1 plate A, rep 1 plate E, rep 1 plate F, rep 2 plate L, rep 2 plate O, rep 2 plate R. We're assuming that 2 plates from the same rep are no more likely to be similar than plates from opposite reps. Is this right? Otherwise we could include rep as a fixed effect w/2 levels (1 or 2).



### Untransformed data

#### 24 hours
```{r,eval=FALSE, echo=FALSE}
load('data/settlement_24.RData')

#The default fixed effect prior has a zero mean vector and a diagonal variance matrix with large variances (1e+10). We'll leave that alone, and specify the random and residual effect priors as follows:
prior_settle24 = list(R=list(V=1,nu=0.002), #R: residual effect
                         G=list(G1=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1))) #G1: breeding value

#fixed effects written as dam-1 means we don't specify a global intercept; each level of dam (A and C) has its own. 
settle24 <- MCMCglmm(prop~dam-1,
                   random=~animal,
                   prior=prior_settle24,
                   ginverse=list(animal=Ainv_24),
                   data=settlement_24,nitt=1000000,burnin=10000,thin=100,verbose=TRUE)

#calculate heritability
model <- settle24
X <- model[['X']] #design matrix relating observations (larvae) to fixed effects (dams)
VF <- apply(model[['Sol']],1,fn_compute_varpred,design_matrix=X)
herit_settle24 <- model$VCV[,1]/(rowSums(model$VCV)+VF)

save(settle24,prior_settle24,herit_settle24,file='C:/Users/eschlatter/Dropbox/coral_h2/analysis/models/settle24.RData')
```

```{r,echo=FALSE, message=FALSE}
load('models/settle24.RData')
settle24_est <- fn_get_estimates(settle24,herit_settle24)
kable(settle24_est)
```

```{r,echo=FALSE, message=FALSE}
load('models/settle24.RData')
model <- settle24
summary(model)
plot(model)

fn_plot_all_priorandpost(model,prior_settle24,xlim=0.1)

summary(herit_settle24)
plot(herit_settle24)
```


#### 48 hours
```{r,eval=FALSE, echo=FALSE}
load('data/settlement_48.RData')

#The default fixed effect prior has a zero mean vector and a diagonal variance matrix with large variances (1e+10). We'll leave that alone, and specify the random and residual effect priors as follows:
prior_settle48 = list(R=list(V=1,nu=0.002), #R: residual effect
                         G=list(G1=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1))) #G1: breeding value

#fixed effects written as dam-1 means we don't specify a global intercept; each level of dam (A and C) has its own. 
settle48 <- MCMCglmm(prop~dam-1,
                   random=~animal,
                   prior=prior_settle48,
                   ginverse=list(animal=Ainv_48),
                   data=settlement_48,nitt=1000000,burnin=10000,thin=100,verbose=TRUE)

#calculate heritability
model <- settle48
X <- model[['X']] #design matrix relating observations (larvae) to fixed effects (dams)
VF <- apply(model[['Sol']],1,fn_compute_varpred,design_matrix=X)
herit_settle48 <- model$VCV[,1]/(rowSums(model$VCV)+VF)

save(settle48,prior_settle48,herit_settle48,file='C:/Users/eschlatter/Dropbox/coral_h2/analysis/models/settle48.RData')
```

```{r,echo=FALSE, message=FALSE}
load('models/settle48.RData')
settle48_est <- fn_get_estimates(settle48,herit_settle48)
kable(settle48_est)
```

```{r,echo=FALSE, message=FALSE}
load('models/settle48.RData')
model <- settle48
summary(model)
plot(model)

fn_plot_all_priorandpost(model,prior_settle48,xlim=0.1)

summary(herit_settle48)
plot(herit_settle48)
```


### Transformed data (arcsin(sqrt))

#### 24 hours
```{r,eval=FALSE, echo=FALSE}
load('data/settlement_24.RData')
settlement_24 <- mutate(settlement_24,prop_transform = asin(sqrt(prop)))

#The default fixed effect prior has a zero mean vector and a diagonal variance matrix with large variances (1e+10). We'll leave that alone, and specify the random and residual effect priors as follows:
prior_settle24_transform = list(R=list(V=1,nu=0.002), #R: residual effect
                         G=list(G1=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1))) #G1: breeding value

#fixed effects written as dam-1 means we don't specify a global intercept; each level of dam (A and C) has its own. 
settle24_transform <- MCMCglmm(prop_transform~dam-1,
                   random=~animal,
                   prior=prior_settle24_transform,
                   ginverse=list(animal=Ainv_24),
                   data=settlement_24,nitt=1000000,burnin=10000,thin=100,verbose=TRUE)

#calculate heritability
model <- settle24_transform
X <- model[['X']] #design matrix relating observations (larvae) to fixed effects (dams)
VF <- apply(model[['Sol']],1,fn_compute_varpred,design_matrix=X)
herit_settle24_transform <- model$VCV[,1]/(rowSums(model$VCV)+VF)

save(settle24_transform,prior_settle24_transform,herit_settle24_transform,file='C:/Users/eschlatter/Dropbox/coral_h2/analysis/models/settle24_transform.RData')
```

```{r,echo=FALSE, message=FALSE}
load('models/settle24_transform.RData')
settle24_transform_est <- fn_get_estimates(settle24_transform,herit_settle24_transform)
kable(settle24_transform_est)
```

```{r,echo=FALSE, message=FALSE}
load('models/settle24_transform.RData')
model <- settle24_transform
summary(model)
plot(model)

fn_plot_all_priorandpost(model,prior_settle24_transform,xlim=0.1)

summary(herit_settle24_transform)
plot(herit_settle24_transform)
```

#### 48 hours

```{r,eval=FALSE, echo=FALSE}
load('data/settlement_48.RData')
settlement_48 <- mutate(settlement_48,prop_transform = asin(sqrt(prop)))

#The default fixed effect prior has a zero mean vector and a diagonal variance matrix with large variances (1e+10). We'll leave that alone, and specify the random and residual effect priors as follows:
prior_settle48_transform = list(R=list(V=1,nu=0.002), #R: residual effect
                         G=list(G1=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1))) #G1: breeding value

#fixed effects written as dam-1 means we don't specify a global intercept; each level of dam (A and C) has its own. 
settle48_transform <- MCMCglmm(prop_transform~dam-1,
                   random=~animal,
                   prior=prior_settle48_transform,
                   ginverse=list(animal=Ainv_48),
                   data=settlement_48,nitt=1000000,burnin=10000,thin=100,verbose=TRUE)

#calculate heritability
model <- settle48_transform
X <- model[['X']] #design matrix relating observations (larvae) to fixed effects (dams)
VF <- apply(model[['Sol']],1,fn_compute_varpred,design_matrix=X)
herit_settle48_transform <- model$VCV[,1]/(rowSums(model$VCV)+VF)

save(settle48_transform,prior_settle48_transform,herit_settle48_transform,file='C:/Users/eschlatter/Dropbox/coral_h2/analysis/models/settle48_transform.RData')
```

```{r,echo=FALSE, message=FALSE}
load('models/settle48_transform.RData')
settle48_transform_est <- fn_get_estimates(settle48_transform,herit_settle48_transform)
kable(settle48_transform_est)
```

```{r,echo=FALSE, message=FALSE}
load('models/settle48_transform.RData')
model <- settle48_transform
summary(model)
plot(model)

fn_plot_all_priorandpost(model,prior_settle48_transform,xlim=0.15)

summary(herit_settle48_transform)
plot(herit_settle48_transform)
```

### Binomial model

#### 24 hours

- Now we're using a binary response variable (called "settled"): 0 for larvae and 1 for recruits.
- The data has one row for each larva.
- Should include clutch as a random effect.
- Can we then leave out dam as a fixed effect? The variance due to dams is included in the clutch variance, so we've effectively controlled for dam statistically. (Right?) And this is good enough, since we don't specifically need to know the effect of dams. (Calculating h2 with fixed effects is more complicated in a GLMM. So I'm leaving it out for now.)
- Try a couple different families. Both mix very badly, but give quite similar estimates.

```{r,eval=FALSE, echo=FALSE}
load('data/settlement_24_binom.RData')

## threshold family
prior_settle24_binom = list(R=list(V=1,fix=1), #R: residual effect. Fixed at 1 for a binomial model.
                         G=list(G1=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1), #G1: breeding value
                                G2=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1))) # G2: clutch

settle24_binom <- MCMCglmm(settled~1,
                   random=~animal+clutch,
                   family = 'threshold',
                   prior=prior_settle24_binom,
                   ginverse=list(animal=Ainv_24_binom),
                   data=settlement_24_binom,nitt=1000000,burnin=10000,thin=100,verbose=TRUE)

summary(settle24_binom)
plot(settle24_binom)

#calculate heritability
model <- settle24_binom
herit_settle24_binom <- model$VCV[,1]/rowSums(model$VCV)


## try ordinal family. Better mixing?
settle24_ord <- MCMCglmm(settled~1,
                   random=~animal+clutch,
                   family = 'ordinal',
                   prior=prior_settle24_binom,
                   ginverse=list(animal=Ainv_24_binom),
                   data=settlement_24_binom,nitt=50000,burnin=1000,thin=10,verbose=TRUE)

summary(settle24_ord)
plot(settle24_ord)

#calculate heritability
model <- settle24_ord
herit_settle24_ord <- model$VCV[,1]/(rowSums(model$VCV)+1)


## how about categorical?
settle24_cat <- MCMCglmm(settled~1,
                   random=~animal+clutch,
                   family = 'categorical',
                   prior=prior_settle24_binom,
                   ginverse=list(animal=Ainv_24_binom),
                   data=settlement_24_binom,nitt=50000,burnin=1000,thin=10,verbose=TRUE)

summary(settle24_cat)
plot(settle24_cat)

#calculate heritability
model <- settle24_cat
herit_settle24_cat <- model$VCV[,1]/(rowSums(model$VCV)+(pi^2)/3)

#save(settle24_transform,prior_settle24_transform,herit_settle24_transform,file='C:/Users/eschlatter/Dropbox/coral_h2/analysis/models/settle24_transform.RData')
```


## Lipids

Two samples per pair of parents (4 for the clones). Each sample has a lipids value and an egg value; we can calculate loss as (lipid-egg)/egg.

That's probably not enough replication for the animal model to make any sense out of it.

## Protein

Four samples per pair of parents (8 for the clones).