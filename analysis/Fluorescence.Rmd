---
title: "Process trait data"
author: "E Schlatter"
date: "10/13/2022"
output: html_document
---

```{r message=FALSE, warning=FALSE}
setwd("/Users/eschlatter/Dropbox/coral_h2")
library(tidyverse)
library(MasterBayes) #for pedigree functions
library(MCMCglmm) #for running the model
library(MCMCpack) #for inverse wishart distributions
library(bayesplot) #mcmc_areas plot function
library(gridExtra) #multiple plots per figure
source('functions.R')
```

## Read in and process the data.

Creates the following objects we'll use going forward:

$\textbf{fluor}$: Contains blue, green, and red fluorescence values. (Each parent also has a row in this list, to be compatible with relatedness matrix, but its traits and covariates are all NA.)

$\textbf{Ainv}$: the inverse of the relatedness matrix, A. In A, $A_{ij}=$probability of identity by descent of an allele in individuals i and j.

```{r data cleanup}
#fluorescence
fluor <- as.data.frame(read.csv('traits/fluor_Final_nosize.csv',header=TRUE)) %>%
  rename(green=geren)
fluor <- mutate(fluor,id=as.character(1:nrow(fluor)))

#pedigree and Ainv -- we'll need this later for heritability analysis
pedigree <- dplyr::select(fluor,id,dam,sire)

#pedigree utility functions (from MasterBayes) to insert parents and correctly order, and create Ainv
full_pedig <- pedigree %>%
  insertPed() %>%
  orderPed()
Ainv <- MCMCglmm::inverseA(full_pedig)$Ainv

#add empty rows to fluor for parents
parents <- subset(full_pedig,is.na(dam)) %>%
  transmute(rep=NA,blue=NA,green=NA,red=NA,sire=NA,dam=NA,id=id)
fluor <- rbind(parents,fluor)

fluor$id <- as.factor(fluor$id)
fluor$rep <- as.factor(fluor$rep)
fluor$sire <- as.factor(fluor$sire)
fluor$dam <- as.factor(fluor$dam)

fluor <- fluor %>% 
  rename(animal=id) %>%
  mutate(red_rel = red/(red+blue+green)) %>%
  mutate(green_rel = green/(red+blue+green)) %>%
  mutate(blue_rel = blue/(red+blue+green))
```

## EDA
```{r}
hist(fluor$red_rel)
ggplot(fluor, aes(x=sire,y=red_rel,color=dam))+
  stat_boxplot()
red_aov=aov(red_rel~sire, data=fluor)
summary(red_aov)
#TukeyHSD(red_aov)


hist(fluor$blue_rel)
ggplot(fluor, aes(x=sire,y=blue_rel,color=dam))+
  stat_boxplot()
blue_aov=aov(blue_rel~sire, data=fluor)
summary(blue_aov)


hist(fluor$green_rel)
ggplot(fluor, aes(x=sire,y=green_rel,color=dam))+
  stat_boxplot()
green_aov=aov(green_rel~sire, data=fluor)
summary(green_aov)
```

## Model: red~animal+sire+dam

```{r}
nu = 0.001
p_var = var(fluor$red_rel,na.rm=TRUE) #total phenotypic variance in relative green fluor
prior_mode = p_var/5 #prior mode (5 variance components)
V = ((nu+2)/nu)*prior_mode #prior parameter V (inverse Wishart) for additive genetic effect

prior1_red = list(R=list(V=V,nu=nu),
                    G=list(G1=list(V=V,nu=nu),G2=list(V=V,nu=nu),
                           G3=list(V=V,nu=nu),G4=list(V=V,nu=nu)))

red_fluor <- MCMCglmm(red_rel~1,
                   random=~animal+rep+sire+dam,
                   prior=prior1_red,
                   ginverse=list(animal=Ainv),
                   data=fluor,nitt=100000,burnin=1000,thin=10,verbose=TRUE)
plot(red_fluor)

figs <- priorandpost_plot(model = red_fluor, prior = prior1_red, xlim=.01)


```
